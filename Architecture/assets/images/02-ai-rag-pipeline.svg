<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 780" font-family="Segoe UI, Arial, sans-serif">
  <defs>
    <linearGradient id="hdrGrad" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0%" stop-color="#b71c1c"/><stop offset="100%" stop-color="#c62828"/>
    </linearGradient>
    <filter id="sh" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="1" dy="2" stdDeviation="3" flood-opacity="0.12"/>
    </filter>
    <marker id="ar" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0,10 3.5,0 7" fill="#546e7a"/>
    </marker>
    <marker id="arRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0,10 3.5,0 7" fill="#e53935"/>
    </marker>
  </defs>

  <rect width="1100" height="780" rx="12" fill="#fafafa"/>

  <!-- Title -->
  <rect x="0" y="0" width="1100" height="56" rx="12" fill="url(#hdrGrad)"/>
  <rect x="0" y="20" width="1100" height="36" fill="url(#hdrGrad)"/>
  <text x="550" y="37" text-anchor="middle" fill="#fff" font-size="20" font-weight="700">AI Integration â€” RAG Pipeline Architecture</text>

  <!-- ===== USER / UI ===== -->
  <rect x="420" y="75" width="260" height="60" rx="10" fill="#e3f2fd" stroke="#1e88e5" stroke-width="1.5" filter="url(#sh)"/>
  <text x="550" y="100" text-anchor="middle" fill="#0d47a1" font-size="14" font-weight="700">ğŸ‘¤ User â†’ React / Next.js UI</text>
  <text x="550" y="118" text-anchor="middle" fill="#546e7a" font-size="10">Submit question with optional filters</text>

  <!-- Arrow down -->
  <line x1="550" y1="135" x2="550" y2="170" stroke="#546e7a" stroke-width="1.5" marker-end="url(#ar)"/>
  <text x="560" y="157" fill="#78909c" font-size="9">POST /api/ask</text>

  <!-- ===== FASTAPI BACKEND ===== -->
  <rect x="350" y="175" width="400" height="55" rx="10" fill="#e8f5e9" stroke="#43a047" stroke-width="1.5" filter="url(#sh)"/>
  <text x="550" y="200" text-anchor="middle" fill="#1b5e20" font-size="14" font-weight="700">FastAPI Backend</text>
  <text x="550" y="218" text-anchor="middle" fill="#546e7a" font-size="10">Validate Â· Sanitise Â· Route to Retrieval &amp; Orchestration</text>

  <!-- Branch left: Retrieval path -->
  <line x1="450" y1="230" x2="250" y2="275" stroke="#e53935" stroke-width="2" marker-end="url(#arRed)"/>
  <text x="320" y="260" fill="#c62828" font-size="10" font-weight="600">â‘  Retrieve</text>

  <!-- Branch right: Orchestration path -->
  <line x1="650" y1="230" x2="850" y2="275" stroke="#e53935" stroke-width="2" marker-end="url(#arRed)"/>

  <!-- ===== STEP 1: QUERY EMBEDDING ===== -->
  <rect x="60" y="280" width="380" height="70" rx="10" fill="#fff3e0" stroke="#fb8c00" stroke-width="1.5" filter="url(#sh)"/>
  <text x="80" y="300" fill="#e65100" font-size="12" font-weight="700">â‘  Query Embedding</text>
  <text x="80" y="318" fill="#37474f" font-size="11">User query â†’ text-embedding-3-large (3 072 dims)</text>
  <text x="80" y="334" fill="#78909c" font-size="10">Azure OpenAI Embeddings API</text>

  <!-- Arrow down -->
  <line x1="250" y1="350" x2="250" y2="380" stroke="#546e7a" stroke-width="1.5" marker-end="url(#ar)"/>

  <!-- ===== STEP 2: HYBRID SEARCH ===== -->
  <rect x="60" y="385" width="380" height="85" rx="10" fill="#fce4ec" stroke="#e53935" stroke-width="1.5" filter="url(#sh)"/>
  <text x="80" y="407" fill="#b71c1c" font-size="12" font-weight="700">â‘¡ Hybrid Search â€” Azure AI Search</text>
  <g fill="#37474f" font-size="11">
    <text x="80" y="427">ğŸ”¢ Vector search (HNSW, cosine similarity)</text>
    <text x="80" y="445">ğŸ“ BM25 lexical search (keyword match)</text>
    <text x="80" y="463">ğŸ”€ Reciprocal Rank Fusion (RRF) merge</text>
  </g>

  <!-- Arrow down -->
  <line x1="250" y1="470" x2="250" y2="500" stroke="#546e7a" stroke-width="1.5" marker-end="url(#ar)"/>

  <!-- ===== STEP 3: METADATA FILTERS ===== -->
  <rect x="60" y="505" width="380" height="60" rx="10" fill="#f3e5f5" stroke="#8e24aa" stroke-width="1.5" filter="url(#sh)"/>
  <text x="80" y="527" fill="#4a148c" font-size="12" font-weight="700">â‘¢ Metadata Filters</text>
  <text x="80" y="545" fill="#37474f" font-size="11">docType Â· confidentiality â‰¤ user clearance Â· dateRange</text>

  <!-- Arrow down -->
  <line x1="250" y1="565" x2="250" y2="595" stroke="#546e7a" stroke-width="1.5" marker-end="url(#ar)"/>

  <!-- ===== STEP 4: TOP-K FUSION ===== -->
  <rect x="60" y="600" width="380" height="60" rx="10" fill="#e0f2f1" stroke="#00897b" stroke-width="1.5" filter="url(#sh)"/>
  <text x="80" y="622" fill="#004d40" font-size="12" font-weight="700">â‘£ Top-K Fusion (K = 5)</text>
  <text x="80" y="640" fill="#37474f" font-size="11">Re-rank (optional cross-encoder) â†’ Top 5 chunks + scores</text>

  <!-- Arrow: Chunks â†’ Orchestration -->
  <line x1="440" y1="630" x2="620" y2="340" stroke="#e53935" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arRed)"/>
  <text x="540" y="470" fill="#c62828" font-size="10" font-weight="600" transform="rotate(-50,540,470)">chunks + metadata</text>

  <!-- ===== STEP 5: PROMPT ORCHESTRATION (right side) ===== -->
  <rect x="620" y="280" width="420" height="180" rx="10" fill="#e8eaf6" stroke="#5c6bc0" stroke-width="1.5" filter="url(#sh)"/>
  <text x="640" y="302" fill="#283593" font-size="12" font-weight="700">â‘¤ Prompt Orchestration &amp; LLM Call</text>

  <rect x="640" y="314" width="380" height="56" rx="6" fill="#fff" stroke="#7986cb" stroke-width="1"/>
  <text x="650" y="332" fill="#37474f" font-size="10" font-weight="600">System Prompt Template</text>
  <text x="650" y="348" fill="#78909c" font-size="9">Role Â· Citation format [Source N] Â· Refusal behaviour</text>
  <text x="650" y="362" fill="#78909c" font-size="9">&lt;context&gt;{chunks}&lt;/context&gt; + User query</text>

  <rect x="640" y="378" width="180" height="35" rx="6" fill="#fff" stroke="#7986cb" stroke-width="1"/>
  <text x="650" y="400" fill="#37474f" font-size="10" font-weight="600">Azure OpenAI</text>
  <text x="730" y="400" fill="#78909c" font-size="9">gpt-4.1 / 4o</text>

  <rect x="835" y="378" width="185" height="35" rx="6" fill="#fff" stroke="#7986cb" stroke-width="1"/>
  <text x="845" y="400" fill="#37474f" font-size="10" font-weight="600">Content Filters</text>
  <text x="927" y="400" fill="#78909c" font-size="9">Azure AI Safety</text>

  <rect x="640" y="420" width="380" height="30" rx="6" fill="#fff" stroke="#7986cb" stroke-width="1"/>
  <text x="650" y="441" fill="#37474f" font-size="10">Token budget: 1 024 reserved answer Â· fill context window</text>

  <!-- Arrow down from Orchestration -->
  <line x1="830" y1="460" x2="830" y2="500" stroke="#546e7a" stroke-width="1.5" marker-end="url(#ar)"/>

  <!-- ===== STEP 6: GUARDRAILS ===== -->
  <rect x="620" y="505" width="420" height="80" rx="10" fill="#fff8e1" stroke="#f9a825" stroke-width="1.5" filter="url(#sh)"/>
  <text x="640" y="527" fill="#e65100" font-size="12" font-weight="700">â‘¥ Guardrails &amp; Confidence Check</text>
  <g fill="#37474f" font-size="11">
    <text x="640" y="548">âœ… Citation validation â€” every claim â†’ [Source N]</text>
    <text x="640" y="566">ğŸ“Š Confidence score (similarity + logprobs) â‰¥ 0.6 threshold</text>
    <text x="640" y="580">ğŸ›¡ Prompt injection defence Â· PII filter</text>
  </g>

  <!-- Arrow down to response -->
  <line x1="830" y1="585" x2="550" y2="640" stroke="#546e7a" stroke-width="1.5" marker-end="url(#ar)"/>

  <!-- ===== RESPONSE ===== -->
  <rect x="350" y="640" width="400" height="60" rx="10" fill="#e8f5e9" stroke="#43a047" stroke-width="1.5" filter="url(#sh)"/>
  <text x="550" y="663" text-anchor="middle" fill="#1b5e20" font-size="13" font-weight="700">Response to User</text>
  <text x="550" y="682" text-anchor="middle" fill="#37474f" font-size="10">{answer, citations[], confidence, tokenUsage}</text>

  <!-- ===== CACHING SIDEBAR ===== -->
  <rect x="60" y="680" width="260" height="80" rx="10" fill="#e0f7fa" stroke="#00897b" stroke-width="1.5" filter="url(#sh)"/>
  <text x="80" y="702" fill="#004d40" font-size="12" font-weight="700">âš¡ Caching Layers</text>
  <text x="80" y="720" fill="#37474f" font-size="10">Semantic cache (sim â‰¥ 0.97) â€” 1 h TTL</text>
  <text x="80" y="736" fill="#37474f" font-size="10">Response cache (exact hash) â€” 15 min TTL</text>
  <text x="80" y="752" fill="#37474f" font-size="10">Embedding cache â€” until re-index</text>

  <!-- Version -->
  <text x="1080" y="772" text-anchor="end" fill="#b0bec5" font-size="9">QI Offerings â€” RAG Pipeline v1.0</text>
</svg>
